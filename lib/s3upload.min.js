(function(){window.S3Upload=function(){function e(e){null==e&&(e={});for(option in e)this[option]=e[option];this.handleFileSelect(document.getElementById(this.file_dom_selector))}return e.prototype.s3_object_name="default_name",e.prototype.s3_sign_put_url="/signS3put",e.prototype.file_dom_selector="file_upload",e.prototype.onFinishS3Put=function(e){return console.log("base.onFinishS3Put()",e)},e.prototype.onProgress=function(e,t){return console.log("base.onProgress()",e,t)},e.prototype.onError=function(e){return console.log("base.onError()",e)},e.prototype.handleFileSelect=function(e){var t,o,n,r,s,i;for(this.onProgress(0,"Upload started."),o=e.files,n=[],i=[],r=0,s=o.length;s>r;r++)t=o[r],i.push(this.uploadFile(t));return i},e.prototype.createCORSRequest=function(e,t){var o;return o=new XMLHttpRequest,null!=o.withCredentials?o.open(e,t,!0):"undefined"!=typeof XDomainRequest?(o=new XDomainRequest,o.open(e,t)):o=null,o},e.prototype.executeOnSignedUrl=function(e,t){var o,n;return o=this,n=new XMLHttpRequest,n.open("GET",this.s3_sign_put_url+"?s3_object_type="+e.type+"&s3_object_name="+this.s3_object_name,!0),n.overrideMimeType("text/plain; charset=x-user-defined"),n.onreadystatechange=function(){var e;if(4===this.readyState&&200===this.status){try{e=JSON.parse(this.responseText)}catch(n){return o.onError('Signing server returned some ugly/empty JSON: "'+this.responseText+'"'),!1}return t(e.signed_request,e.url)}return 4===this.readyState&&200!==this.status?o.onError("Could not contact request signing server. Status = "+this.status):void 0},n.send()},e.prototype.uploadToS3=function(e,t,o){var n,r;return n=this,r=this.createCORSRequest("PUT",t),r?(r.onload=function(){return 200===r.status?(n.onProgress(100,"Upload completed."),n.onFinishS3Put(o)):n.onError("Upload error: "+r.status)},r.onerror=function(){return n.onError("XHR error.")},r.upload.onprogress=function(e){var t;return e.lengthComputable?(t=Math.round(e.loaded/e.total*100),n.onProgress(t,100===t?"Finalizing.":"Uploading.")):void 0}):this.onError("CORS not supported"),r.setRequestHeader("Content-Type",e.type),r.setRequestHeader("x-amz-acl","public-read"),r.send(e)},e.prototype.uploadFile=function(e){var t;return t=this,this.executeOnSignedUrl(e,function(o,n){return t.uploadToS3(e,o,n)})},e}()}).call(this);